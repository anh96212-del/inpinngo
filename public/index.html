<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Garden AI Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- CSS MODERN STYLE --- */
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --dark: #2b2d42;
            --light: #f8f9fa;
            --sidebar-bg: #1e1e2d;
            --card-bg: #ffffff;
        }

        body { font-family: 'Inter', sans-serif; margin: 0; background-color: #f0f2f5; color: var(--dark); }
        
        /* Login Screen */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #4361ee, #f72585); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-box { background: white; padding: 40px; border-radius: 16px; width: 350px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #e0e0e0; border-radius: 8px; box-sizing: border-box; font-size: 14px; transition: 0.3s; }
        .login-input:focus { border-color: var(--primary); outline: none; }
        .login-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px; transition: 0.3s; }
        .login-btn:hover { background: var(--secondary); transform: translateY(-2px); }

        /* Main Layout */
        #main-app { display: none; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 260px; background: var(--sidebar-bg); color: #a2a3b7; display: flex; flex-direction: column; transition: 0.3s; }
        .sidebar-header { padding: 30px 20px; font-size: 24px; font-weight: bold; color: white; display: flex; align-items: center; gap: 10px; }
        .menu-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: 0.3s; font-size: 15px; margin: 5px 15px; border-radius: 10px; }
        .menu-item:hover, .menu-item.active { background: #2b2b40; color: white; }
        .menu-item i { width: 20px; text-align: center; }
        .logout { margin-top: auto; margin-bottom: 20px; color: var(--danger); }
        .logout:hover { background: rgba(247, 37, 133, 0.1); }

        .content { flex: 1; padding: 30px; overflow-y: auto; background: #f5f8fa; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .user-info { display: flex; align-items: center; gap: 10px; background: white; padding: 8px 15px; border-radius: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        /* Cards & Grid */
        .section { display: none; animation: fadeIn 0.5s; }
        .section.active { display: block; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 30px; }
        
        .card { background: var(--card-bg); padding: 25px; border-radius: 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); border: 1px solid rgba(0,0,0,0.03); transition: 0.3s; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); }
        .card-icon { position: absolute; top: 20px; right: 20px; font-size: 40px; opacity: 0.1; color: var(--primary); }
        
        .label { color: #7e8299; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 10px; }
        .value { font-size: 36px; font-weight: 700; color: var(--dark); }
        .sub-text { font-size: 12px; color: #b5b5c3; margin-top: 5px; display: block; }

        /* AI Card Special */
        .card-ai { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .card-ai .label, .card-ai .value, .card-ai .sub-text { color: white !important; }
        .card-ai .card-icon { color: white; opacity: 0.2; }
        .btn-ai { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; cursor: pointer; margin-top: 10px; transition: 0.3s; }
        .btn-ai:hover { background: white; color: var(--primary); }

        /* Controls */
        .control-panel { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 5px 20px rgba(0,0,0,0.03); margin-bottom: 30px; }
        .btn { padding: 12px 24px; margin-right: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: white; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn:disabled { background-color: #e9ecef !important; color: #adb5bd !important; cursor: not-allowed; }
        .btn-auto { background: linear-gradient(45deg, #4361ee, #4895ef); }
        .btn-manual { background: linear-gradient(45deg, #f72585, #b5179e); }
        .btn-off { background: #6c757d; }
        .btn-on { background: #2ecc71; }
        .btn-danger { background: #e74c3c; }

        /* Wifi Alert & Scheduler */
        #wifi-alert { display: none; background: #fff0f3; color: #d63031; padding: 15px; border-radius: 10px; border: 1px solid #ffccd5; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }

        .scheduler-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .scheduler-box { background: #f8f9fa; padding: 20px; border-radius: 12px; border: 1px dashed #ced4da; }
        .time-input { padding: 10px; border: 1px solid #ced4da; border-radius: 6px; font-family: inherit; font-size: 16px; }

        /* Chart & Inputs */
        .date-picker { padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; margin-right: 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <div style="font-size: 50px; margin-bottom: 10px;">üå±</div>
            <h2 style="margin: 0 0 20px 0; color: #2b2d42;">Smart Garden AI</h2>
            <input type="text" id="username" class="login-input" placeholder="T√™n ƒëƒÉng nh·∫≠p">
            <input type="password" id="password" class="login-input" placeholder="M·∫≠t kh·∫©u">
            <button class="login-btn" onclick="handleLogin()">ƒêƒÇNG NH·∫¨P <i class="fas fa-arrow-right"></i></button>
            <p id="login-msg" style="color: var(--danger); font-size: 13px; margin-top: 15px;"></p>
        </div>
    </div>

    <div id="main-app">
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-leaf" style="color: var(--success);"></i> SmartGarden
            </div>
            <div class="menu-item active" onclick="showSection('dashboard')"><i class="fas fa-chart-pie"></i> T·ªïng Quan</div>
            <div class="menu-item" onclick="showSection('report')"><i class="fas fa-chart-line"></i> B√°o C√°o</div>
            <div class="menu-item" onclick="showSection('config')"><i class="fas fa-cogs"></i> C·∫•u H√¨nh</div>
            <div class="menu-item logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t</div>
        </div>

        <div class="content">
            <div class="header-bar">
                <h2 id="page-title" style="margin:0;">Dashboard</h2>
                <div class="user-info">
                    <img src="https://ui-avatars.com/api/?name=Admin&background=random" style="width: 30px; border-radius: 50%;">
                    <span id="user-role" style="font-weight: 600; font-size: 14px;">--</span>
                </div>
            </div>

            <div id="wifi-alert" style="display: none;">
                <i class="fas fa-wifi"></i>
                <span><b>M·∫§T K·∫æT N·ªêI!</b> Thi·∫øt b·ªã kh√¥ng ph·∫£n h·ªìi trong 60s qua. Vui l√≤ng ki·ªÉm tra ngu·ªìn ƒëi·ªán.</span>
            </div>

            <div id="dashboard" class="section active">
                <div class="dashboard-grid">
                    <div class="card">
                        <i class="fas fa-tint card-icon"></i>
                        <span class="label">ƒê·ªô ·∫®m ƒê·∫•t</span>
                        <div class="value" style="color: var(--success);"><span id="hum">--</span>%</div>
                        <span class="sub-text" id="hum-raw">(C·∫£m bi·∫øn: --)</span>
                    </div>
                    <div class="card">
                        <i class="fas fa-water card-icon"></i>
                        <span class="label">Tr·∫°ng th√°i B∆°m</span>
                        <div class="value" id="pump-status">--</div>
                        <span class="sub-text">Th·ªùi gian th·ª±c</span>
                    </div>
                    <div class="card">
                        <i class="fas fa-robot card-icon"></i>
                        <span class="label">Ch·∫ø ƒë·ªô ho·∫°t ƒë·ªông</span>
                        <div class="value" id="mode-status" style="color: var(--primary);">--</div>
                        <span class="sub-text">ƒêi·ªÅu khi·ªÉn</span>
                    </div>
                    <div class="card card-ai">
                        <i class="fas fa-brain card-icon"></i>
                        <span class="label">TR√ç TU·ªÜ NH√ÇN T·∫†O (AI)</span>
                        <div class="value" style="font-size: 28px;" id="ai-threshold">Ng∆∞·ª°ng: --</div>
                        <span class="sub-text" id="ai-status" style="color: rgba(255,255,255,0.8);">ƒêang ph√¢n t√≠ch d·ªØ li·ªáu...</span>
                        <button class="btn-ai" onclick="checkAI()"><i class="fas fa-sync-alt"></i> C·∫≠p nh·∫≠t AI</button>
                    </div>
                </div>

                <div class="control-panel" id="admin-controls">
                    <h3 style="margin-top:0;"><i class="fas fa-gamepad"></i> Trung T√¢m ƒêi·ªÅu Khi·ªÉn</h3>
                    
                    <div class="scheduler-container">
                        <div>
                            <p class="label">Ch·ªçn Ch·∫ø ƒê·ªô:</p>
                            <div style="margin-bottom: 20px;">
                                <button class="btn btn-auto" onclick="sendCommand('SET_MODE_AUTO')"><i class="fas fa-magic"></i> AUTO (AI)</button>
                                <button class="btn btn-manual" onclick="sendCommand('SET_MODE_MANUAL')"><i class="fas fa-hand-pointer"></i> MANUAL</button>
                                <button class="btn btn-off" onclick="sendCommand('SET_MODE_OFF')"><i class="fas fa-power-off"></i> D·ª™NG</button>
                            </div>
                            
                            <p class="label">ƒêi·ªÅu khi·ªÉn B∆°m (Ch·∫ø ƒë·ªô Manual):</p>
                            <div>
                                <button class="btn btn-on" onclick="sendCommand('PUMP_ON')"><i class="fas fa-play"></i> B·∫¨T B∆†M</button>
                                <button class="btn btn-danger" onclick="sendCommand('PUMP_OFF')"><i class="fas fa-stop"></i> T·∫ÆT B∆†M</button>
                            </div>
                        </div>

                        <div class="scheduler-box">
                            <p class="label" style="color: var(--dark);"><i class="far fa-clock"></i> L·ªãch T∆∞·ªõi T·ª± ƒê·ªông (H√†ng ng√†y)</p>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input type="time" id="schedule-time" class="time-input">
                                <button class="btn btn-auto" style="padding: 8px 15px; margin:0;" onclick="saveSchedule()">L∆∞u</button>
                                <button class="btn btn-off" style="padding: 8px 15px; margin:0; background: #95a5a6;" onclick="clearSchedule()">X√≥a</button>
                            </div>
                            <p id="schedule-display" style="font-size: 13px; color: #666;">Ch∆∞a c√≥ l·ªãch.</p>
                        </div>
                    </div>
                </div>
                <div id="guest-msg" style="display:none; text-align:center; color: var(--danger);">B·∫°n l√† Kh√°ch (User), ch·ªâ c√≥ quy·ªÅn xem.</div>
            </div>

            <div id="report" class="section">
                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="margin-top:0;">B·ªô L·ªçc Th·ªùi Gian</h3>
                    <div style="display: flex; align-items: flex-end; gap: 15px; flex-wrap: wrap;">
                        <div>
                            <label class="label">T·ª´ ng√†y</label>
                            <input type="date" id="date-start" class="date-picker">
                        </div>
                        <div>
                            <label class="label">ƒê·∫øn ng√†y</label>
                            <input type="date" id="date-end" class="date-picker">
                        </div>
                        <button class="btn btn-manual" style="margin:0; height: 40px;" onclick="loadReport()"><i class="fas fa-filter"></i> L·ªçc D·ªØ Li·ªáu</button>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="card">
                        <span class="label">T·ªïng S·ªë L·∫ßn T∆∞·ªõi</span>
                        <div class="value" id="rep-pump">0</div>
                        <span class="sub-text">Trong kho·∫£ng th·ªùi gian ch·ªçn</span>
                    </div>
                    <div class="card">
                        <span class="label">ƒê·ªô ·∫®m Trung B√¨nh</span>
                        <div class="value" id="rep-hum">0%</div>
                        <span class="sub-text">M·ª©c ƒë·ªô gi·ªØ n∆∞·ªõc c·ªßa ƒë·∫•t</span>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin-top:0;">Bi·ªÉu ƒê·ªì Di·ªÖn Bi·∫øn ƒê·ªô ·∫®m</h3>
                    <canvas id="myChart" height="100"></canvas>
                </div>
            </div>

            <div id="config" class="section">
                <div class="config-form card" style="margin: 0 auto;">
                    <h3 style="text-align: center;"><i class="fas fa-wifi"></i> C·∫•u H√¨nh WiFi Thi·∫øt B·ªã</h3>
                    <p style="text-align: center; font-size: 13px; color: #666; margin-bottom: 20px;">Nh·∫≠p th√¥ng tin WiFi m·ªõi ƒë·ªÉ g·ª≠i xu·ªëng ESP8266</p>
                    
                    <label class="label">T√™n WiFi (SSID)</label>
                    <input type="text" id="conf-ssid" class="login-input" placeholder="V√≠ d·ª•: WiFi_Nha_Minh">
                    
                    <label class="label">M·∫≠t kh·∫©u</label>
                    <input type="password" id="conf-pass" class="login-input" placeholder="********">
                    
                    <button class="btn btn-auto" style="width:100%; justify-content: center; margin-top: 10px;" onclick="saveConfig()"><i class="fas fa-paper-plane"></i> G·ª≠i C·∫•u H√¨nh</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const IP = ""; // T·ª± ƒë·ªông l·∫•y host
        let currentUser = null;
        let chartInstance = null;
        const SENSOR_DRY = 1024; 
        const SENSOR_WET = 400;  
        
        // Bi·∫øn l·ªãch tr√¨nh
        let scheduledTime = localStorage.getItem('smartGardenSchedule') || null;
        let isScheduleTriggered = false; 

        function convertHum(rawVal) {
            let percent = ((SENSOR_DRY - rawVal) / (SENSOR_DRY - SENSOR_WET)) * 100;
            return Math.max(0, Math.min(100, Math.round(percent)));
        }

        async function handleLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            try {
                const res = await fetch(IP + '/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();
                if (data.success) {
                    currentUser = data;
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-app').style.display = 'flex';
                    document.getElementById('user-role').innerText = data.name; // Hi·ªÉn th·ªã t√™n
                    if (data.role === 'user') {
                        document.getElementById('admin-controls').style.display = 'none';
                        document.getElementById('guest-msg').style.display = 'block';
                    }
                    
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('date-start').value = today;
                    document.getElementById('date-end').value = today;

                    startDashboard();
                    updateScheduleUI();
                } else {
                    document.getElementById('login-msg').innerText = data.message;
                }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi Server!"); }
        }

        function logout() { location.reload(); }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            // Highlight menu item
            // Logic ƒë∆°n gi·∫£n ƒë·ªÉ active ƒë√∫ng menu
            const menus = document.querySelectorAll('.menu-item');
            if(id=='dashboard') menus[0].classList.add('active');
            if(id=='report') menus[1].classList.add('active');
            if(id=='config') menus[2].classList.add('active');

            document.getElementById("page-title").innerText = id === 'config' ? 'C·∫•u H√¨nh' : (id === 'report' ? 'B√°o C√°o' : 'Dashboard');

            if (id === 'report') loadReport(); 
        }

        async function updateDashboard() {
            try {
                let res = await fetch(IP + "/api/web/current");
                let data = await res.json();
                
                // --- C·∫¢NH B√ÅO WIFI ---
                if (data.timestamp) {
                    const lastUpdate = new Date(data.timestamp);
                    const now = new Date();
                    const diffSeconds = (now - lastUpdate) / 1000;
                    
                    const alertBox = document.getElementById('wifi-alert');
                    if (diffSeconds > 60) { 
                        alertBox.style.display = 'flex';
                    } else {
                        alertBox.style.display = 'none';
                    }
                }

                document.getElementById("hum").innerText = convertHum(data.humidity);
                document.getElementById("hum-raw").innerText = "(Raw: " + data.humidity + ")";
                
                const pStatus = data.pumpState == 1 ? "ƒêANG B·∫¨T" : "ƒêANG T·∫ÆT";
                const pColor = data.pumpState == 1 ? "var(--success)" : "#95a5a6";
                const pEl = document.getElementById("pump-status");
                pEl.innerText = pStatus;
                pEl.style.color = pColor;

                let mStt = "OFF";
                if(data.mode == 1) mStt = "AUTO (AI)";
                if(data.mode == 2) mStt = "MANUAL";
                document.getElementById("mode-status").innerText = mStt;
            } catch(e) {}
        }

        async function checkAI() {
            try {
                document.getElementById('ai-status').innerText = "ƒêang k·∫øt n·ªëi Server...";
                let res = await fetch(IP + "/api/test-smart");
                let data = await res.json();
                document.getElementById('ai-threshold').innerText = "Ng∆∞·ª°ng: " + data.config.threshold;
                document.getElementById('ai-status').innerText = data.config.status;
            } catch(e) {
                document.getElementById('ai-status').innerText = "L·ªói k·∫øt n·ªëi AI";
            }
        }

        // L·ªãch Tr√¨nh + T·ª± t·∫Øt sau 2 ph√∫t
        function checkScheduleLoop() {
            if (!scheduledTime) return; 
            const now = new Date();
            const currentHM = now.toTimeString().substring(0, 5); 
            if (currentHM === scheduledTime) {
                if (!isScheduleTriggered) {
                    sendCommand('PUMP_ON'); 
                    setTimeout(() => {
                        sendCommand('PUMP_OFF');
                        console.log("‚è∞ ƒê√£ t·ª± ƒë·ªông t·∫Øt b∆°m (timeout).");
                    }, 120000); // 2 ph√∫t
                    isScheduleTriggered = true; 
                }
            } else {
                isScheduleTriggered = false; 
            }
        }

        function saveSchedule() {
            const timeVal = document.getElementById('schedule-time').value;
            if (!timeVal) return alert("Vui l√≤ng ch·ªçn gi·ªù!");
            scheduledTime = timeVal;
            localStorage.setItem('smartGardenSchedule', scheduledTime);
            updateScheduleUI();
            alert("ƒê√£ l∆∞u l·ªãch t∆∞·ªõi: " + scheduledTime);
        }

        function clearSchedule() {
            scheduledTime = null;
            localStorage.removeItem('smartGardenSchedule');
            updateScheduleUI();
            alert("ƒê√£ x√≥a l·ªãch.");
        }

        function updateScheduleUI() {
            const display = document.getElementById('schedule-display');
            const input = document.getElementById('schedule-time');
            if (scheduledTime) {
                display.innerHTML = `H·∫πn gi·ªù: <b style="color:var(--primary)">${scheduledTime}</b> h√†ng ng√†y (Ch·∫°y 2 ph√∫t).`;
                input.value = scheduledTime;
            } else {
                display.innerText = "Ch∆∞a c√≥ l·ªãch h·∫πn.";
                input.value = "";
            }
        }

        function startDashboard() {
            updateDashboard();
            checkAI(); 
            setInterval(() => {
                updateDashboard();
                checkScheduleLoop(); 
            }, 2000);
        }

        async function sendCommand(cmd) {
            if (currentUser.role !== 'admin') return alert("Kh√¥ng c√≥ quy·ªÅn!");
            await fetch(IP + "/api/web/command", {
                method: "POST", headers: {"Content-Type":"application/json"},
                body: JSON.stringify({cmd: cmd})
            });
            console.log("ƒê√£ g·ª≠i: " + cmd);
        }

        async function loadReport() {
            try {
                const dStart = document.getElementById('date-start').value;
                const dEnd = document.getElementById('date-end').value;
                if(!dStart || !dEnd) return alert("Vui l√≤ng ch·ªçn ng√†y!");
                
                let res = await fetch(IP + `/api/report/stats?start=${dStart}&end=${dEnd}`);
                let data = await res.json();

                document.getElementById('rep-pump').innerText = data.pumpCount;
                document.getElementById('rep-hum').innerText = convertHum(data.avgHumidity) + "%";

                const ctx = document.getElementById('myChart').getContext('2d');
                if (chartInstance) chartInstance.destroy();
                
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.chartData.map(d => {
                            const date = new Date(d.timestamp);
                            return `${date.getDate()}/${date.getMonth()+1} ${date.getHours()}:${date.getMinutes()}`;
                        }),
                        datasets: [{
                            label: 'ƒê·ªô ·∫©m (%)',
                            data: data.chartData.map(d => convertHum(d.humidity)),
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        scales: { y: { beginAtZero: true, max: 100 } }
                    }
                });
            } catch(e) { console.log(e); alert("L·ªói t·∫£i b√°o c√°o"); }
        }

        function saveConfig() {
            if (currentUser.role !== 'admin') return alert("Ch·ªâ Admin m·ªõi ƒë∆∞·ª£c s·ª≠a!");
            const s = document.getElementById('conf-ssid').value;
            const p = document.getElementById('conf-pass').value;
            sendCommand(`CONF_WIFI:${s},${p}`);
            alert("ƒê√£ g·ª≠i c·∫•u h√¨nh xu·ªëng ESP!");
        }
    </script>
</body>
</html>s
